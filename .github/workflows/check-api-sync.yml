name: Check API Sync

on:
  schedule:
    # Run daily at 9am UTC
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual triggers

concurrency:
  group: api-sync
  cancel-in-progress: true

jobs:
  fetch-spec:
    name: 游깷 Fetch OpenAPI Spec
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      - name: 游닌 Checkout repository
        uses: actions/checkout@v6

      - name: 游릭 Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: 游닍 Install dependencies
        run: npm ci

      - name: 游깷 Fetch latest OpenAPI spec
        run: npm run fetch-spec

      - name: 游 Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add uw-api-spec.yaml
          git diff --staged --quiet || git commit -m "chore: update OpenAPI spec"
          git push || true

  check-sync:
    name: 游댌 Check API Sync
    runs-on: ubuntu-latest
    needs: fetch-spec
    timeout-minutes: 5
    permissions:
      contents: read
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}

    steps:
      - name: 游닌 Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      - name: 游댃 Pull latest changes
        run: git pull --ff-only

      - name: 游릭 Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: 游닍 Install dependencies
        run: npm ci

      - name: 游댌 Compare endpoints
        id: check
        run: |
          if npm run check-api; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

  create-issues:
    name: 游닇 Create GitHub Issues
    runs-on: ubuntu-latest
    needs: check-sync
    if: needs.check-sync.outputs.has_changes == 'true'
    timeout-minutes: 5
    permissions:
      contents: read
      issues: write

    steps:
      - name: 游닌 Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      - name: 游댃 Pull latest changes
        run: git pull --ff-only

      - name: 游릭 Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: 游닍 Install dependencies
        run: npm ci

      - name: 游닇 Create issues for API changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CREATE_ISSUES: 'true'
        run: npm run check-api || true
